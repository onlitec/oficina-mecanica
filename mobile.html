<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Oficina Mobile">
    <title>üì± Oficina Mobile - Dashboard</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header Mobile */
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .menu-btn:active {
            background: rgba(255,255,255,0.2);
        }
        
        .logo-mobile {
            font-size: 18px;
            font-weight: bold;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            position: relative;
            transition: background 0.3s ease;
        }
        
        .notification-btn:active {
            background: rgba(255,255,255,0.2);
        }
        
        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:active {
            transform: scale(0.98);
        }
        
        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Quick Actions */
        .quick-actions {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .action-btn {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 16px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            text-decoration: none;
            color: inherit;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }
        
        .action-label {
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }
        
        /* Recent Items */
        .recent-section {
            margin-bottom: 20px;
        }
        
        .recent-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .recent-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .recent-item:last-child {
            border-bottom: none;
        }
        
        .recent-item:active {
            background: #f8f9fa;
        }
        
        .recent-icon {
            font-size: 20px;
            width: 32px;
            text-align: center;
        }
        
        .recent-content {
            flex: 1;
        }
        
        .recent-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .recent-subtitle {
            font-size: 12px;
            color: #666;
        }
        
        .recent-time {
            font-size: 11px;
            color: #999;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s ease;
            text-decoration: none;
            color: inherit;
        }
        
        .nav-item:active {
            background: #f0f0f0;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            display: block;
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .side-menu.open {
            left: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .menu-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 16px;
        }
        
        .menu-user {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .menu-role {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .menu-items {
            padding: 16px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            text-decoration: none;
            color: inherit;
        }
        
        .menu-item:active {
            background: #f0f0f0;
        }
        
        .menu-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }
        
        .menu-item-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 320px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Pull to Refresh */
        .pull-refresh {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #667eea;
            color: white;
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        
        .pull-refresh.active {
            transform: translateY(60px);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="mobile-header">
        <div class="header-left">
            <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
            <div class="logo-mobile">üöó Oficina</div>
        </div>
        <div class="header-right">
            <button class="notification-btn" onclick="openNotifications()">
                üîî
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="menu-overlay" onclick="closeMenu()"></div>
    <div class="side-menu">
        <div class="menu-header">
            <div class="menu-user" id="menuUserName">Carregando...</div>
            <div class="menu-role" id="menuUserRole">...</div>
        </div>
        <div class="menu-items">
            <a href="/mobile.html" class="menu-item">
                <span class="menu-item-icon">üè†</span>
                <span class="menu-item-label">Dashboard</span>
            </a>
            <a href="/mobile-customers.html" class="menu-item">
                <span class="menu-item-icon">üë•</span>
                <span class="menu-item-label">Clientes</span>
            </a>
            <a href="/mobile-orders.html" class="menu-item">
                <span class="menu-item-icon">üìã</span>
                <span class="menu-item-label">Ordens de Servi√ßo</span>
            </a>
            <a href="/mobile-parts.html" class="menu-item">
                <span class="menu-item-icon">üì¶</span>
                <span class="menu-item-label">Pe√ßas</span>
            </a>
            <a href="/mobile-financial.html" class="menu-item">
                <span class="menu-item-icon">üí∞</span>
                <span class="menu-item-label">Financeiro</span>
            </a>
            <a href="/notifications.html" class="menu-item">
                <span class="menu-item-icon">üîî</span>
                <span class="menu-item-label">Notifica√ß√µes</span>
            </a>
            <div class="menu-item" onclick="logout()">
                <span class="menu-item-icon">üö™</span>
                <span class="menu-item-label">Sair</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Pull to Refresh -->
        <div class="pull-refresh" id="pullRefresh">
            <span class="loading-spinner"></span>
            Atualizando...
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card" onclick="openPage('/mobile-orders.html')">
                <div class="stat-icon">üìã</div>
                <div class="stat-value" id="totalOrders">-</div>
                <div class="stat-label">Ordens Abertas</div>
            </div>
            <div class="stat-card" onclick="openPage('/mobile-customers.html')">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalCustomers">-</div>
                <div class="stat-label">Clientes</div>
            </div>
            <div class="stat-card" onclick="openPage('/mobile-financial.html')">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="pendingInvoices">-</div>
                <div class="stat-label">Faturas Pendentes</div>
            </div>
            <div class="stat-card" onclick="openPage('/mobile-parts.html')">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="lowStockParts">-</div>
                <div class="stat-label">Estoque Baixo</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="section-title">A√ß√µes R√°pidas</div>
            <div class="actions-grid">
                <a href="/mobile-order-form.html" class="action-btn">
                    <span class="action-icon">‚ûï</span>
                    <span class="action-label">Nova OS</span>
                </a>
                <a href="/mobile-customer-form.html" class="action-btn">
                    <span class="action-icon">üë§</span>
                    <span class="action-label">Cliente</span>
                </a>
                <a href="/mobile-part-form.html" class="action-btn">
                    <span class="action-icon">üì¶</span>
                    <span class="action-label">Pe√ßa</span>
                </a>
                <button class="action-btn" onclick="scanQR()">
                    <span class="action-icon">üì∑</span>
                    <span class="action-label">Scan QR</span>
                </button>
                <button class="action-btn" onclick="quickSearch()">
                    <span class="action-icon">üîç</span>
                    <span class="action-label">Buscar</span>
                </button>
                <a href="/mobile-reports.html" class="action-btn">
                    <span class="action-icon">üìä</span>
                    <span class="action-label">Relat√≥rios</span>
                </a>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="recent-section">
            <div class="section-title">Ordens Recentes</div>
            <div class="recent-list" id="recentOrders">
                <div class="loading">
                    <span class="loading-spinner"></span>
                    Carregando ordens...
                </div>
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="recent-section">
            <div class="section-title">Notifica√ß√µes</div>
            <div class="recent-list" id="recentNotifications">
                <div class="loading">
                    <span class="loading-spinner"></span>
                    Carregando notifica√ß√µes...
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="/mobile.html" class="nav-item active">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">In√≠cio</span>
        </a>
        <a href="/mobile-orders.html" class="nav-item">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">Ordens</span>
        </a>
        <a href="/mobile-customers.html" class="nav-item">
            <span class="nav-icon">üë•</span>
            <span class="nav-label">Clientes</span>
        </a>
        <a href="/mobile-parts.html" class="nav-item">
            <span class="nav-icon">üì¶</span>
            <span class="nav-label">Pe√ßas</span>
        </a>
        <a href="/mobile-financial.html" class="nav-item">
            <span class="nav-icon">üí∞</span>
            <span class="nav-label">Financeiro</span>
        </a>
    </div>

    <script>
        let currentUser = null;
        let touchStartY = 0;
        let isPulling = false;

        // Verificar autentica√ß√£o
        function checkAuth() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = '/login.html';
                return null;
            }
            return JSON.parse(user);
        }

        // Logout
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Toggle menu
        function toggleMenu() {
            const menu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.menu-overlay');
            
            menu.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        // Close menu
        function closeMenu() {
            const menu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.menu-overlay');
            
            menu.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Open page
        function openPage(url) {
            window.location.href = url;
        }

        // Open notifications
        function openNotifications() {
            window.location.href = '/notifications.html';
        }

        // Scan QR (placeholder)
        function scanQR() {
            alert('Funcionalidade de QR Code ser√° implementada em breve!');
        }

        // Quick search (placeholder)
        function quickSearch() {
            const query = prompt('Digite sua busca:');
            if (query) {
                alert(`Buscando por: ${query}`);
            }
        }

        // Load user info
        function loadUserInfo() {
            currentUser = checkAuth();
            if (currentUser) {
                document.getElementById('menuUserName').textContent = currentUser.name;
                document.getElementById('menuUserRole').textContent = currentUser.role;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load stats
                await Promise.all([
                    loadStats(),
                    loadRecentOrders(),
                    loadRecentNotifications()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const [ordersRes, customersRes, invoicesRes, partsRes] = await Promise.all([
                    fetch('/api/service-orders?status=OPEN&limit=1'),
                    fetch('/api/customers?limit=1'),
                    fetch('/api/financial/invoices?status=PENDING&limit=1'),
                    fetch('/api/parts?lowStock=true&limit=1')
                ]);

                const [orders, customers, invoices, parts] = await Promise.all([
                    ordersRes.json(),
                    customersRes.json(),
                    invoicesRes.json(),
                    partsRes.json()
                ]);

                document.getElementById('totalOrders').textContent = orders.pagination?.total || 0;
                document.getElementById('totalCustomers').textContent = customers.pagination?.total || 0;
                document.getElementById('pendingInvoices').textContent = invoices.pagination?.total || 0;
                document.getElementById('lowStockParts').textContent = parts.pagination?.total || 0;
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Load recent orders
        async function loadRecentOrders() {
            try {
                const response = await fetch('/api/service-orders?limit=5');
                const data = await response.json();

                const container = document.getElementById('recentOrders');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(order => `
                        <div class="recent-item" onclick="openPage('/mobile-order-view.html?id=${order.id}')">
                            <div class="recent-icon">üìã</div>
                            <div class="recent-content">
                                <div class="recent-title">${order.number}</div>
                                <div class="recent-subtitle">${order.customer?.name || 'Cliente n√£o informado'}</div>
                                <div class="recent-time">${formatDate(order.createdAt)}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="recent-item"><div class="recent-content"><div class="recent-title">Nenhuma ordem encontrada</div></div></div>';
                }
            } catch (error) {
                console.error('Erro ao carregar ordens recentes:', error);
                document.getElementById('recentOrders').innerHTML = '<div class="recent-item"><div class="recent-content"><div class="recent-title">Erro ao carregar</div></div></div>';
            }
        }

        // Load recent notifications
        async function loadRecentNotifications() {
            try {
                if (!currentUser) return;

                const response = await fetch(`/api/notifications/user/${currentUser.id}?limit=3`);
                const data = await response.json();

                const container = document.getElementById('recentNotifications');
                const badge = document.getElementById('notificationBadge');
                
                if (data.success && data.data.length > 0) {
                    const unreadCount = data.unreadCount || 0;
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }

                    container.innerHTML = data.data.map(notification => `
                        <div class="recent-item ${!notification.isRead ? 'unread' : ''}" onclick="openNotifications()">
                            <div class="recent-icon">${getNotificationIcon(notification.type)}</div>
                            <div class="recent-content">
                                <div class="recent-title">${notification.title}</div>
                                <div class="recent-subtitle">${notification.message}</div>
                                <div class="recent-time">${formatDate(notification.createdAt)}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    badge.style.display = 'none';
                    container.innerHTML = '<div class="recent-item"><div class="recent-content"><div class="recent-title">Nenhuma notifica√ß√£o</div></div></div>';
                }
            } catch (error) {
                console.error('Erro ao carregar notifica√ß√µes:', error);
                document.getElementById('recentNotifications').innerHTML = '<div class="recent-item"><div class="recent-content"><div class="recent-title">Erro ao carregar</div></div></div>';
            }
        }

        // Helper functions
        function getNotificationIcon(type) {
            const icons = {
                'INVOICE_DUE': 'üìÖ',
                'INVOICE_OVERDUE': 'üö®',
                'PAYMENT_RECEIVED': 'üí∞',
                'LOW_STOCK': 'üì¶',
                'OUT_OF_STOCK': '‚ùå',
                'FINANCIAL_GOAL': 'üéØ',
                'SYSTEM_ALERT': '‚ö†Ô∏è',
                'REMINDER': 'üîî'
            };
            return icons[type] || 'üì¢';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'Agora';
            if (diffMins < 60) return `${diffMins}min`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;
            
            return date.toLocaleDateString('pt-BR');
        }

        // Pull to refresh
        function initPullToRefresh() {
            const mainContent = document.querySelector('.main-content');
            const pullRefresh = document.getElementById('pullRefresh');

            mainContent.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            });

            mainContent.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const pullDistance = touchY - touchStartY;

                if (pullDistance > 0 && mainContent.scrollTop === 0) {
                    e.preventDefault();
                    
                    if (pullDistance > 60) {
                        pullRefresh.classList.add('active');
                        isPulling = true;
                    }
                }
            });

            mainContent.addEventListener('touchend', () => {
                if (isPulling) {
                    pullRefresh.classList.remove('active');
                    isPulling = false;
                    
                    // Refresh data
                    loadDashboardData();
                }
            });
        }

        // Register Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('Nova vers√£o dispon√≠vel! Atualizar agora?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadDashboardData();
            initPullToRefresh();
            registerServiceWorker();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - Oficina Mec√¢nica</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-layout">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span class="logo-icon">üöó</span>
                <span>Minha Oficina</span>
            </a>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/dashboard.html" class="nav-link">
                            <span>üìä</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/customers.html" class="nav-link">
                            <span>üë•</span>
                            Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/service-orders.html" class="nav-link">
                            <span>üîß</span>
                            Ordens de Servi√ßo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/parts.html" class="nav-link">
                            <span>‚öôÔ∏è</span>
                            Pe√ßas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/financial.html" class="nav-link active">
                            <span>üí∞</span>
                            Financeiro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/reports.html" class="nav-link">
                            <span>üìà</span>
                            Relat√≥rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/settings.html" class="nav-link">
                            <span>‚öôÔ∏è</span>
                            Configura√ß√µes
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="user-menu">
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar">U</div>
                    <span id="userName">Usu√°rio</span>
                    <span>‚ñº</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="card">
            <div class="card-header">
                <div>
                    <h1 class="card-title">
                        <span>üí∞</span>
                        Gest√£o Financeira
                    </h1>
                    <p class="card-subtitle">Controle de faturamento, pagamentos e fluxo de caixa</p>
                </div>
                <div style="display: flex; gap: var(--space-3);">
                    <a href="/invoices.html" class="btn btn-secondary">
                        <span>üìÑ</span>
                        Ver Faturas
                    </a>
                    <a href="/service-order-form.html" class="btn btn-primary">
                        <span>‚ûï</span>
                        Nova OS
                    </a>
                </div>
            </div>
        </div>

        <!-- Filtros de Per√≠odo -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üìÖ</span>
                    Per√≠odo de An√°lise
                </h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate" class="form-label">Data Inicial</label>
                        <input type="date" id="startDate" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="endDate" class="form-label">Data Final</label>
                        <input type="date" id="endDate" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="quickPeriod" class="form-label">Per√≠odo R√°pido</label>
                        <select id="quickPeriod" class="form-input" onchange="setQuickPeriod()">
                            <option value="">Personalizado</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month">Este M√™s</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este Ano</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: var(--space-4);">
                    <button class="btn btn-primary" onclick="loadDashboard()">
                        <span>üîç</span>
                        Atualizar Dashboard
                    </button>
                    <button class="btn btn-secondary" onclick="exportFinancialReport()">
                        <span>üìä</span>
                        Exportar Relat√≥rio
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div style="text-align: center; padding: var(--space-6); color: var(--text-secondary);">
                        <div class="loading-spinner" style="margin-bottom: var(--space-3);"></div>
                        <p>Carregando dashboard financeiro...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div style="text-align: center; padding: var(--space-6); color: var(--error-color);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-3);">‚ùå</div>
                        <h3 style="margin-bottom: var(--space-2);">Erro ao carregar dados</h3>
                        <p id="errorMessage" style="margin-bottom: var(--space-4);">Erro desconhecido</p>
                        <button class="btn btn-primary" onclick="loadDashboard()">
                            <span>üîÑ</span>
                            Tentar Novamente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            <!-- Informa√ß√µes do Per√≠odo -->
            <div class="card" id="periodInfo" style="margin-bottom: var(--space-6); display: none;">
                <div class="card-body">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <span id="periodText"></span>
                    </div>
                </div>
            </div>

            <!-- M√©tricas Principais -->
            <div class="stats-grid" style="margin-bottom: var(--space-6);">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="totalInvoices">0</div>
                            <div class="stat-label">Total de Faturas</div>
                        </div>
                        <div class="stat-icon primary">üìä</div>
                    </div>
                    <div class="stat-trend" id="invoicesTrend"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value success" id="totalRevenue">R$ 0,00</div>
                            <div class="stat-label">Receita Total</div>
                        </div>
                        <div class="stat-icon success">üí∞</div>
                    </div>
                    <div class="stat-trend" id="revenueTrend"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value warning" id="totalPending">R$ 0,00</div>
                            <div class="stat-label">Valores Pendentes</div>
                        </div>
                        <div class="stat-icon warning">‚è≥</div>
                    </div>
                    <div class="stat-trend" id="pendingTrend"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value info" id="averageInvoice">R$ 0,00</div>
                            <div class="stat-label">Valor M√©dio</div>
                        </div>
                        <div class="stat-icon info">üìà</div>
                    </div>
                    <div class="stat-trend" id="averageTrend"></div>
                </div>
            </div>

            <!-- Gr√°fico de Receita -->
            <div class="card" style="margin-bottom: var(--space-6);">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üìà</span>
                        Evolu√ß√£o da Receita
                    </h2>
                    <div>
                        <select id="chartPeriod" class="form-input" onchange="updateChart()" style="width: auto;">
                            <option value="daily">Di√°rio</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly">Mensal</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 300px; position: relative;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Faturas Recentes e Pendentes -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); margin-bottom: var(--space-6);">
                <!-- Faturas Recentes -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span>üìÑ</span>
                            Faturas Recentes
                        </h2>
                        <a href="/invoices.html" class="btn btn-sm btn-secondary">Ver Todas</a>
                    </div>
                    <div class="card-body">
                        <div id="recentInvoices">
                            <div style="text-align: center; padding: var(--space-4); color: var(--text-secondary);">
                                <div class="loading-spinner" style="margin-bottom: var(--space-2);"></div>
                                <p>Carregando faturas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Faturas Pendentes -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span>‚ö†Ô∏è</span>
                            Faturas Pendentes
                        </h2>
                        <span class="badge badge-warning" id="pendingCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="pendingInvoices">
                            <div style="text-align: center; padding: var(--space-4); color: var(--text-secondary);">
                                <div class="loading-spinner" style="margin-bottom: var(--space-2);"></div>
                                <p>Carregando faturas pendentes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumo de Pagamentos -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üí≥</span>
                        Resumo de Pagamentos
                    </h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
                        <div style="text-align: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-lg); font-weight: 600; color: var(--success-color);" id="paidAmount">R$ 0,00</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Pagos</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-lg); font-weight: 600; color: var(--warning-color);" id="overdueAmount">R$ 0,00</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Em Atraso</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-lg); font-weight: 600; color: var(--info-color);" id="futureAmount">R$ 0,00</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">A Vencer</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        let revenueChart = null;
        
        // Verificar autentica√ß√£o
        const auth = new AuthManager();
        if (!auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        // Atualizar nome do usu√°rio
        const user = auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name || user.email;
            document.querySelector('.user-avatar').textContent = (user.name || user.email).charAt(0).toUpperCase();
        }

        // Toggle user menu
        function toggleUserMenu() {
            const confirmed = confirm('Deseja fazer logout?');
            if (confirmed) {
                auth.logout();
                window.location.href = '/login.html';
            }
        }

        // Definir datas padr√£o (m√™s atual)
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);

            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }

        // Definir per√≠odo r√°pido
        function setQuickPeriod() {
            const period = document.getElementById('quickPeriod').value;
            const today = new Date();
            let startDate, endDate = today;

            switch (period) {
                case 'today':
                    startDate = today;
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    break;
                default:
                    return;
            }

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        // Exportar relat√≥rio financeiro
        function exportFinancialReport() {
            showInfoNotification('Funcionalidade de exporta√ß√£o ser√° implementada em breve!');
        }
        
        // Carregar dashboard
        async function loadDashboard() {
            try {
                showLoading();

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (!startDate || !endDate) {
                    showError('Por favor, selecione as datas inicial e final');
                    return;
                }

                // Simular dados para demonstra√ß√£o
                const mockData = generateMockData(startDate, endDate);

                // Simular delay da API
                await new Promise(resolve => setTimeout(resolve, 1000));

                displayDashboard(mockData);
                showContent();

            } catch (error) {
                showError('Erro de conex√£o: ' + error.message);
            }
        }

        // Gerar dados mock para demonstra√ß√£o
        function generateMockData(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            return {
                totalInvoices: Math.floor(Math.random() * 50) + 20,
                totalRevenue: (Math.random() * 50000 + 10000).toFixed(2),
                totalPending: (Math.random() * 15000 + 2000).toFixed(2),
                averageInvoice: (Math.random() * 2000 + 500).toFixed(2),
                paidAmount: (Math.random() * 35000 + 8000).toFixed(2),
                overdueAmount: (Math.random() * 5000 + 1000).toFixed(2),
                futureAmount: (Math.random() * 10000 + 2000).toFixed(2),
                recentInvoices: generateMockInvoices(5),
                pendingInvoices: generateMockInvoices(3, true),
                chartData: generateChartData(days)
            };
        }

        // Gerar faturas mock
        function generateMockInvoices(count, pending = false) {
            const invoices = [];
            const customers = ['Jo√£o Silva', 'Maria Santos', 'Pedro Costa', 'Ana Oliveira', 'Carlos Souza'];

            for (let i = 0; i < count; i++) {
                invoices.push({
                    id: Math.floor(Math.random() * 1000) + 1,
                    number: `FAT-${String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0')}`,
                    customer: customers[Math.floor(Math.random() * customers.length)],
                    amount: (Math.random() * 3000 + 200).toFixed(2),
                    date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: pending ? 'PENDING' : 'PAID'
                });
            }

            return invoices;
        }

        // Gerar dados do gr√°fico
        function generateChartData(days) {
            const data = [];
            for (let i = 0; i < Math.min(days, 30); i++) {
                data.push({
                    date: new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    revenue: Math.random() * 2000 + 100
                });
            }
            return data.reverse();
        }
        
        // Exibir dashboard
        function displayDashboard(data) {
            // Informa√ß√µes do per√≠odo
            const startDate = new Date(document.getElementById('startDate').value).toLocaleDateString('pt-BR');
            const endDate = new Date(document.getElementById('endDate').value).toLocaleDateString('pt-BR');
            document.getElementById('periodText').textContent = `Per√≠odo: ${startDate} at√© ${endDate}`;
            document.getElementById('periodInfo').style.display = 'block';

            // M√©tricas principais
            document.getElementById('totalInvoices').textContent = data.totalInvoices || 0;
            document.getElementById('totalRevenue').textContent = formatCurrency(data.totalRevenue);
            document.getElementById('totalPending').textContent = formatCurrency(data.totalPending);
            document.getElementById('averageInvoice').textContent = formatCurrency(data.averageInvoice);

            // Resumo de pagamentos
            document.getElementById('paidAmount').textContent = formatCurrency(data.paidAmount);
            document.getElementById('overdueAmount').textContent = formatCurrency(data.overdueAmount);
            document.getElementById('futureAmount').textContent = formatCurrency(data.futureAmount);

            // Gr√°fico de receita
            createRevenueChart(data.chartData);

            // Faturas
            displayRecentInvoices(data.recentInvoices);
            displayPendingInvoices(data.pendingInvoices);

            // Atualizar contador de pendentes
            document.getElementById('pendingCount').textContent = data.pendingInvoices.length;
        }
        
        // Criar gr√°fico de receita
        function createRevenueChart(dailyRevenue) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            const labels = dailyRevenue.map(item => item.date);
            const amounts = dailyRevenue.map(item => item.amount);
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: amounts,
                        borderColor: '#28a745',
                        backgroundColor: '#28a74520',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Receita: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Receita (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Exibir faturas recentes
        function displayRecentInvoices(invoices) {
            const container = document.getElementById('recentInvoices');

            if (!invoices || invoices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: var(--space-4); color: var(--text-secondary);">Nenhuma fatura encontrada no per√≠odo.</div>';
                return;
            }

            container.innerHTML = invoices.map(invoice => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border-bottom: 1px solid var(--bg-tertiary);">
                    <div>
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">${invoice.number}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${invoice.customer}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">${formatDate(invoice.date)}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--success-color);">${formatCurrency(invoice.amount)}</div>
                        <span class="badge badge-success">Pago</span>
                    </div>
                </div>
            `).join('');
        }

        // Exibir faturas pendentes
        function displayPendingInvoices(invoices) {
            const container = document.getElementById('pendingInvoices');

            if (!invoices || invoices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: var(--space-4); color: var(--text-secondary);">Nenhuma fatura pendente.</div>';
                return;
            }

            container.innerHTML = invoices.map(invoice => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border-bottom: 1px solid var(--bg-tertiary);">
                    <div>
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">${invoice.number}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${invoice.customer}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">${formatDate(invoice.date)}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--warning-color);">${formatCurrency(invoice.amount)}</div>
                        <span class="badge badge-warning">Pendente</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Obter label do status
        function getStatusLabel(status) {
            const labels = {
                'PENDING': 'Pendente',
                'PAID': 'Pago',
                'OVERDUE': 'Vencido',
                'CANCELLED': 'Cancelado'
            };
            return labels[status] || status;
        }
        
        // Formatar moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }
        
        // Estados da interface
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        // Fun√ß√£o para formatar data
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        // Fun√ß√£o para atualizar gr√°fico
        function updateChart() {
            // Implementar atualiza√ß√£o do gr√°fico baseado no per√≠odo selecionado
            console.log('Atualizando gr√°fico...');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadDashboard();
        });
    </script>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/logo-manager.js"></script>
    <script src="/modelo2-features.js"></script>
</body>
</html>

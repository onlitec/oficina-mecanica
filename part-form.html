<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Pe√ßa - Oficina Mec√¢nica</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-layout">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span class="logo-icon">üöó</span>
                <span>Minha Oficina</span>
            </a>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/dashboard.html" class="nav-link">
                            <span>üìä</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/customers.html" class="nav-link">
                            <span>üë•</span>
                            Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/service-orders.html" class="nav-link">
                            <span>üîß</span>
                            Ordens de Servi√ßo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/parts.html" class="nav-link active">
                            <span>‚öôÔ∏è</span>
                            Pe√ßas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/financial.html" class="nav-link">
                            <span>üí∞</span>
                            Financeiro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/reports.html" class="nav-link">
                            <span>üìà</span>
                            Relat√≥rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/settings.html" class="nav-link">
                            <span>‚öôÔ∏è</span>
                            Configura√ß√µes
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="user-menu">
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar">U</div>
                    <span id="userName">Usu√°rio</span>
                    <span>‚ñº</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="card">
            <div class="card-header">
                <div>
                    <h1 class="card-title">
                        <span>‚öôÔ∏è</span>
                        Cadastro de Pe√ßa
                    </h1>
                    <p class="card-subtitle">Cadastre uma nova pe√ßa no estoque</p>
                </div>
                <a href="/parts.html" class="btn btn-secondary">
                    <span>‚Üê</span>
                    Voltar
                </a>
            </div>
        </div>

        <!-- Formul√°rio -->
        <div class="card">
            <div class="card-body">
                <div id="alert" class="alert" style="display: none;"></div>

                <form id="partForm">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>üìã</span>
                                Informa√ß√µes B√°sicas
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name" class="form-label required">Nome da Pe√ßa</label>
                                    <input type="text" id="name" name="name" class="form-input" required placeholder="Digite o nome da pe√ßa">
                                    <div class="form-error" id="nameError"></div>
                                </div>

                                <div class="form-group">
                                    <label for="internalCode" class="form-label">C√≥digo Interno</label>
                                    <input type="text" id="internalCode" name="internalCode" class="form-input" placeholder="Ex: P001">
                                    <div class="form-error" id="internalCodeError"></div>
                                    <div class="form-help">C√≥digo √∫nico para identifica√ß√£o interna</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="barcode" class="form-label">C√≥digo de Barras</label>
                                    <input type="text" id="barcode" name="barcode" class="form-input" placeholder="Ex: 7891234567890">
                                    <div class="form-error" id="barcodeError"></div>
                                </div>

                                <div class="form-group">
                                    <label for="category" class="form-label">Categoria</label>
                                    <select id="category" name="category" class="form-input">
                                        <option value="PARTS">Pe√ßas</option>
                                        <option value="ACCESSORIES">Acess√≥rios</option>
                                        <option value="FLUIDS">Fluidos</option>
                                        <option value="TOOLS">Ferramentas</option>
                                        <option value="CONSUMABLES">Consum√≠veis</option>
                                        <option value="OTHER">Outros</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="description" class="form-label">Descri√ß√£o</label>
                                <textarea id="description" name="description" class="form-input" rows="3" placeholder="Descri√ß√£o detalhada da pe√ßa, aplica√ß√£o, caracter√≠sticas..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Especifica√ß√µes -->
                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>üîß</span>
                                Especifica√ß√µes T√©cnicas
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="brand" class="form-label">Marca</label>
                                    <input type="text" id="brand" name="brand" class="form-input" placeholder="Ex: Bosch, Mann, NGK">
                                </div>

                                <div class="form-group">
                                    <label for="model" class="form-label">Modelo</label>
                                    <input type="text" id="model" name="model" class="form-input" placeholder="Modelo espec√≠fico da pe√ßa">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="unit" class="form-label">Unidade de Medida</label>
                                    <select id="unit" name="unit" class="form-input">
                                        <option value="UN">Unidade (UN)</option>
                                        <option value="PC">Pe√ßa (PC)</option>
                                        <option value="KG">Quilograma (KG)</option>
                                        <option value="L">Litro (L)</option>
                                        <option value="M">Metro (M)</option>
                                        <option value="M2">Metro Quadrado (M¬≤)</option>
                                        <option value="CX">Caixa (CX)</option>
                                        <option value="PCT">Pacote (PCT)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="status" class="form-label">Status</label>
                                    <select id="status" name="status" class="form-input">
                                        <option value="ACTIVE">Ativo</option>
                                        <option value="INACTIVE">Inativo</option>
                                    </select>
                                    <div class="form-help">Pe√ßas inativas n√£o aparecem nas vendas</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pre√ßos -->
                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>üí∞</span>
                                Pre√ßos e Margem
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="costPrice" class="form-label">Pre√ßo de Custo (R$)</label>
                                    <input type="number" id="costPrice" name="costPrice" class="form-input" min="0" step="0.01" placeholder="0,00">
                                    <div class="form-help">Valor pago ao fornecedor</div>
                                </div>

                                <div class="form-group">
                                    <label for="salePrice" class="form-label">Pre√ßo de Venda (R$)</label>
                                    <input type="number" id="salePrice" name="salePrice" class="form-input" min="0" step="0.01" placeholder="0,00">
                                    <div class="form-help">Valor cobrado do cliente</div>
                                </div>
                            </div>

                            <div id="priceCalculation" style="display: none; margin-top: var(--space-4); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                <h4 style="margin-bottom: var(--space-3); color: var(--text-primary);">üìä An√°lise de Margem</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: var(--space-1);">Margem de Lucro:</div>
                                        <div id="profitMargin" style="font-size: var(--font-size-lg); font-weight: 600; color: var(--success-color);">0%</div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: var(--space-1);">Lucro por Unidade:</div>
                                        <div id="profitPerUnit" style="font-size: var(--font-size-lg); font-weight: 600; color: var(--success-color);">R$ 0,00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estoque -->
                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>üì¶</span>
                                Controle de Estoque
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="stock" class="form-label">Quantidade em Estoque</label>
                                    <input type="number" id="stock" name="stock" class="form-input" min="0" value="0">
                                </div>

                                <div class="form-group">
                                    <label for="minStock" class="form-label">Estoque M√≠nimo</label>
                                    <input type="number" id="minStock" name="minStock" class="form-input" min="0" value="0">
                                    <div class="form-help">Quantidade m√≠nima para alerta</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="maxStock" class="form-label">Estoque M√°ximo</label>
                                    <input type="number" id="maxStock" name="maxStock" class="form-input" min="0" placeholder="Opcional">
                                    <div class="form-help">Limite m√°ximo de estoque</div>
                                </div>

                                <div class="form-group">
                                    <label for="reorderPoint" class="form-label">Ponto de Reposi√ß√£o</label>
                                    <input type="number" id="reorderPoint" name="reorderPoint" class="form-input" min="0" placeholder="Opcional">
                                    <div class="form-help">Quantidade para nova compra</div>
                                </div>
                            </div>

                            <div id="stockInfo" style="display: none; margin-top: var(--space-4); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                <h4 style="margin-bottom: var(--space-3); color: var(--text-primary);">üìä Status do Estoque</h4>
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <div id="stockIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: var(--success-color);"></div>
                                    <span id="stockStatusText" style="font-weight: 600;">Status do Estoque</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fornecedores e Localiza√ß√£o -->
                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>üè™</span>
                                Fornecedores e Localiza√ß√£o
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mainSupplier" class="form-label">Fornecedor Principal</label>
                                    <input type="text" id="mainSupplier" name="mainSupplier" class="form-input" placeholder="Nome do fornecedor principal">
                                </div>

                                <div class="form-group">
                                    <label for="location" class="form-label">Localiza√ß√£o no Estoque</label>
                                    <input type="text" id="location" name="location" class="form-input" placeholder="Ex: Estante A1, Prateleira 3">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="alternativeSuppliers" class="form-label">Fornecedores Alternativos</label>
                                    <textarea id="alternativeSuppliers" name="alternativeSuppliers" class="form-input" rows="3" placeholder="Lista de fornecedores alternativos (um por linha)"></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="expiryDate" class="form-label">Data de Validade</label>
                                    <input type="date" id="expiryDate" name="expiryDate" class="form-input">
                                    <div class="form-help">Para pe√ßas com prazo de validade</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observa√ß√µes -->
                    <div class="card" style="margin-bottom: var(--space-6);">
                        <div class="card-header">
                            <h2 class="card-title">
                                <span>üìù</span>
                                Observa√ß√µes
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="observations" class="form-label">Observa√ß√µes Gerais</label>
                                <textarea id="observations" name="observations" class="form-input" rows="4" placeholder="Informa√ß√µes adicionais sobre a pe√ßa, aplica√ß√£o, compatibilidade, etc."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- A√ß√µes -->
                    <div class="card">
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <a href="/parts.html" class="btn btn-secondary">
                                    <span>‚Üê</span>
                                    Cancelar
                                </a>
                                <div style="display: flex; gap: var(--space-3);">
                                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                        <span>üóëÔ∏è</span>
                                        Limpar
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <span>üíæ</span>
                                        Salvar Pe√ßa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <script>
        let isEditing = false;
        let partId = null;
        
        // Verificar autentica√ß√£o
        const auth = new AuthManager();
        if (!auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        // Atualizar nome do usu√°rio
        const user = auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name || user.email;
            document.querySelector('.user-avatar').textContent = (user.name || user.email).charAt(0).toUpperCase();
        }

        // Toggle user menu
        function toggleUserMenu() {
            const confirmed = confirm('Deseja fazer logout?');
            if (confirmed) {
                auth.logout();
                window.location.href = '/login.html';
            }
        }

        // Limpar formul√°rio
        function clearForm() {
            if (confirm('Tem certeza que deseja limpar todos os campos?')) {
                document.getElementById('partForm').reset();
                document.getElementById('priceCalculation').style.display = 'none';
                document.getElementById('stockInfo').style.display = 'none';
            }
        }

        // Calcular margem de lucro
        function calculateProfitMargin() {
            const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;

            if (costPrice > 0 && salePrice > 0) {
                const profit = salePrice - costPrice;
                const margin = (profit / costPrice) * 100;

                document.getElementById('profitMargin').textContent = margin.toFixed(2) + '%';
                document.getElementById('profitPerUnit').textContent = formatCurrency(profit);
                document.getElementById('priceCalculation').style.display = 'block';

                // Colorir margem baseado no valor
                const marginElement = document.getElementById('profitMargin');
                const profitElement = document.getElementById('profitPerUnit');

                if (margin < 10) {
                    marginElement.style.color = 'var(--error-color)';
                    profitElement.style.color = 'var(--error-color)';
                } else if (margin < 30) {
                    marginElement.style.color = 'var(--warning-color)';
                    profitElement.style.color = 'var(--warning-color)';
                } else {
                    marginElement.style.color = 'var(--success-color)';
                    profitElement.style.color = 'var(--success-color)';
                }
            } else {
                document.getElementById('priceCalculation').style.display = 'none';
            }
        }
        
        // Atualizar status do estoque
        function updateStockStatus() {
            const stock = parseInt(document.getElementById('stock').value) || 0;
            const minStock = parseInt(document.getElementById('minStock').value) || 0;

            const stockInfo = document.getElementById('stockInfo');
            const indicator = document.getElementById('stockIndicator');
            const statusText = document.getElementById('stockStatusText');

            if (stock <= 0) {
                indicator.style.background = 'var(--error-color)';
                statusText.textContent = 'Sem Estoque';
                statusText.style.color = 'var(--error-color)';
            } else if (stock <= minStock && minStock > 0) {
                indicator.style.background = 'var(--warning-color)';
                statusText.textContent = 'Estoque Baixo';
                statusText.style.color = 'var(--warning-color)';
            } else {
                indicator.style.background = 'var(--success-color)';
                statusText.textContent = 'Estoque Normal';
                statusText.style.color = 'var(--success-color)';
            }

            stockInfo.style.display = 'block';
        }
        
        // Formatar moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }
        
        // Mostrar alerta
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Validar formul√°rio
        function validateForm() {
            clearErrors();
            let isValid = true;
            
            const name = document.getElementById('name').value.trim();
            if (!name) {
                showError('nameError', 'Nome da pe√ßa √© obrigat√≥rio');
                isValid = false;
            }
            
            return isValid;
        }
        
        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }
        
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error');
            errorElements.forEach(el => el.textContent = '');
        }
        
        // Carregar pe√ßa para edi√ß√£o
        async function loadPart(id) {
            try {
                const response = await fetch(`/api/parts/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const part = data.data;
                    
                    // Preencher campos b√°sicos
                    document.getElementById('name').value = part.name || '';
                    document.getElementById('internalCode').value = part.internalCode || '';
                    document.getElementById('barcode').value = part.barcode || '';
                    document.getElementById('category').value = part.category || 'PARTS';
                    document.getElementById('description').value = part.description || '';
                    document.getElementById('brand').value = part.brand || '';
                    document.getElementById('model').value = part.model || '';
                    document.getElementById('unit').value = part.unit || 'UN';
                    document.getElementById('status').value = part.status || 'ACTIVE';
                    
                    // Pre√ßos
                    document.getElementById('costPrice').value = part.costPrice || '';
                    document.getElementById('salePrice').value = part.salePrice || part.price || '';
                    
                    // Estoque
                    document.getElementById('stock').value = part.stock || 0;
                    document.getElementById('minStock').value = part.minStock || 0;
                    document.getElementById('maxStock').value = part.maxStock || '';
                    document.getElementById('reorderPoint').value = part.reorderPoint || '';
                    
                    // Fornecedores e localiza√ß√£o
                    document.getElementById('mainSupplier').value = part.mainSupplier || part.supplier || '';
                    document.getElementById('location').value = part.location || '';
                    document.getElementById('alternativeSuppliers').value = part.alternativeSuppliers || '';
                    
                    if (part.expiryDate) {
                        const date = new Date(part.expiryDate);
                        document.getElementById('expiryDate').value = date.toISOString().split('T')[0];
                    }
                    
                    document.getElementById('observations').value = part.observations || '';
                    
                    // Atualizar c√°lculos
                    calculateProfitMargin();
                    updateStockStatus();
                    
                    // Atualizar interface
                    document.getElementById('pageTitle').textContent = '‚úèÔ∏è Editar Pe√ßa';
                    document.getElementById('submitBtn').innerHTML = 'üíæ Atualizar Pe√ßa';
                    
                } else {
                    showAlert('Erro ao carregar pe√ßa: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Erro de conex√£o: ' + error.message, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('costPrice').addEventListener('input', calculateProfitMargin);
        document.getElementById('salePrice').addEventListener('input', calculateProfitMargin);
        document.getElementById('stock').addEventListener('input', updateStockStatus);
        document.getElementById('minStock').addEventListener('input', updateStockStatus);
        
        // Submeter formul√°rio
        document.getElementById('partForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Salvando...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // Limpar campos vazios
                Object.keys(data).forEach(key => {
                    if (data[key] === '') {
                        data[key] = null;
                    }
                });
                
                const url = isEditing ? `/api/parts/${partId}` : '/api/parts';
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const message = isEditing ? 'Pe√ßa atualizada com sucesso!' : 'Pe√ßa cadastrada com sucesso!';
                    showSuccessNotification(message);
                    setTimeout(() => {
                        window.location.href = '/parts.html';
                    }, 2000);
                } else {
                    showErrorNotification('Erro: ' + result.error);
                }
            } catch (error) {
                showErrorNotification('Erro de conex√£o: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Event listeners para c√°lculos
        document.getElementById('costPrice').addEventListener('input', calculateProfitMargin);
        document.getElementById('salePrice').addEventListener('input', calculateProfitMargin);
        document.getElementById('stock').addEventListener('input', updateStockStatus);
        document.getElementById('minStock').addEventListener('input', updateStockStatus);

        // Event listener para o formul√°rio
        document.getElementById('partForm').addEventListener('submit', handleSubmit);

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se √© edi√ß√£o
            const urlParams = new URLSearchParams(window.location.search);
            partId = urlParams.get('id');
            if (partId) {
                isEditing = true;
                document.querySelector('.card-title').innerHTML = '<span>‚úèÔ∏è</span> Editar Pe√ßa';
                document.querySelector('.card-subtitle').textContent = 'Edite as informa√ß√µes da pe√ßa';
                document.getElementById('submitBtn').innerHTML = '<span>üíæ</span> Atualizar Pe√ßa';
                loadPart(partId);
            }

            // Atualizar status inicial do estoque
            updateStockStatus();
        });
    </script>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/logo-manager.js"></script>
    <script src="/modelo2-features.js"></script>
</body>
</html>

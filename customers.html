<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Oficina Mec√¢nica</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-layout">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span class="logo-icon">üöó</span>
                <span>Minha Oficina</span>
            </a>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/dashboard.html" class="nav-link">
                            <span>üìä</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/customers.html" class="nav-link active">
                            <span>üë•</span>
                            Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/service-orders.html" class="nav-link">
                            <span>üîß</span>
                            Ordens de Servi√ßo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/parts.html" class="nav-link">
                            <span>‚öôÔ∏è</span>
                            Pe√ßas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/financial.html" class="nav-link">
                            <span>üí∞</span>
                            Financeiro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/reports.html" class="nav-link">
                            <span>üìà</span>
                            Relat√≥rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/settings.html" class="nav-link">
                            <span>‚öôÔ∏è</span>
                            Configura√ß√µes
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="user-menu">
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar">U</div>
                    <span id="userName">Usu√°rio</span>
                    <span>‚ñº</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="card">
            <div class="card-header">
                <div>
                    <h1 class="card-title">
                        <span>üë•</span>
                        Gest√£o de Clientes
                    </h1>
                    <p class="card-subtitle">Gerencie todos os clientes da oficina</p>
                </div>
                <a href="/customer-form.html" class="btn btn-primary">
                    <span>‚ûï</span>
                    Novo Cliente
                </a>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üîç</span>
                    Buscar Clientes
                </h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchName" class="form-label">Nome do Cliente</label>
                        <input type="text" id="searchName" class="form-input" placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="searchEmail" class="form-label">Email</label>
                        <input type="email" id="searchEmail" class="form-input" placeholder="Digite o email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchPhone" class="form-label">Telefone</label>
                        <input type="text" id="searchPhone" class="form-input" placeholder="Digite o telefone">
                    </div>
                    <div class="form-group">
                        <label for="searchType" class="form-label">Tipo</label>
                        <select id="searchType" class="form-input">
                            <option value="">Todos</option>
                            <option value="INDIVIDUAL">Pessoa F√≠sica</option>
                            <option value="COMPANY">Pessoa Jur√≠dica</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <button onclick="searchCustomers()" class="btn btn-primary">
                        <span>üîç</span>
                        Buscar
                    </button>
                    <button onclick="clearSearch()" class="btn btn-secondary">
                        <span>üóëÔ∏è</span>
                        Limpar
                    </button>
                    <button onclick="loadCustomers()" class="btn btn-success">
                        <span>üìã</span>
                        Listar Todos
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Clientes -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üìã</span>
                    Lista de Clientes
                </h2>
                <div class="card-subtitle">
                    Total: <span id="totalCustomers">0</span> clientes
                </div>
            </div>
            <div class="card-body">
                <div id="loadingMessage" style="display: none;">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">Carregando clientes...</p>
                    </div>
                </div>
                
                <div id="errorMessage" style="display: none;"></div>
                
                <div id="customersContainer">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <p>Clique em "Listar Todos" para carregar os clientes</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/logo-manager.js"></script>
    <script src="/modelo2-features.js"></script>
    
    <script>
        // Verificar autentica√ß√£o
        const auth = new AuthManager();
        if (!auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        // Atualizar nome do usu√°rio
        const user = auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name || user.email;
            document.querySelector('.user-avatar').textContent = (user.name || user.email).charAt(0).toUpperCase();
        }

        // Toggle user menu
        function toggleUserMenu() {
            const confirmed = confirm('Deseja fazer logout?');
            if (confirmed) {
                auth.logout();
                window.location.href = '/login.html';
            }
        }

        // Fun√ß√µes da API
        async function apiCall(endpoint) {
            try {
                const response = await fetch(endpoint);
                return await response.json();
            } catch (error) {
                throw new Error(`Erro na API: ${error.message}`);
            }
        }

        // Carregar clientes
        async function loadCustomers() {
            showLoading();
            try {
                const response = await apiCall('/api/customers');
                const customers = response.data || response;
                displayCustomers(customers);
                document.getElementById('totalCustomers').textContent = customers.length;
            } catch (error) {
                showError('Erro ao carregar clientes: ' + error.message);
            }
        }

        // Buscar clientes
        async function searchCustomers() {
            const name = document.getElementById('searchName').value;
            const email = document.getElementById('searchEmail').value;
            const phone = document.getElementById('searchPhone').value;
            const type = document.getElementById('searchType').value;

            if (!name && !email && !phone && !type) {
                alert('Digite pelo menos um crit√©rio de busca');
                return;
            }

            showLoading();
            try {
                const response = await apiCall('/api/customers');
                const customers = response.data || response;
                
                const filtered = customers.filter(customer => {
                    return (!name || customer.name.toLowerCase().includes(name.toLowerCase())) &&
                           (!email || customer.email?.toLowerCase().includes(email.toLowerCase())) &&
                           (!phone || customer.phone?.includes(phone)) &&
                           (!type || customer.type === type);
                });

                displayCustomers(filtered);
                document.getElementById('totalCustomers').textContent = filtered.length;
            } catch (error) {
                showError('Erro ao buscar clientes: ' + error.message);
            }
        }

        // Limpar busca
        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchType').value = '';
            document.getElementById('customersContainer').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);"><p>Clique em "Listar Todos" para carregar os clientes</p></div>';
            document.getElementById('totalCustomers').textContent = '0';
        }

        // Exibir clientes
        function displayCustomers(customers) {
            const container = document.getElementById('customersContainer');
            
            if (customers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);"><p>Nenhum cliente encontrado</p></div>';
                return;
            }

            let html = '<div class="stats-grid">';
            
            customers.forEach(customer => {
                html += `
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-3);">
                                <div>
                                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-1);">${customer.name}</h3>
                                    <span class="badge ${customer.type === 'INDIVIDUAL' ? 'badge-primary' : 'badge-secondary'}">${customer.type === 'INDIVIDUAL' ? 'Pessoa F√≠sica' : 'Pessoa Jur√≠dica'}</span>
                                </div>
                                <div style="display: flex; gap: var(--space-2);">
                                    <a href="/customer-form.html?id=${customer.id}" class="btn btn-sm btn-secondary">‚úèÔ∏è Editar</a>
                                    <a href="/service-order-form.html?customerId=${customer.id}" class="btn btn-sm btn-primary">üîß Nova OS</a>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2); font-size: var(--font-size-sm); color: var(--text-secondary);">
                                <div><strong>Email:</strong> ${customer.email || 'N√£o informado'}</div>
                                <div><strong>Telefone:</strong> ${customer.phone || 'N√£o informado'}</div>
                                <div><strong>CPF/CNPJ:</strong> ${customer.cpfCnpj || 'N√£o informado'}</div>
                                <div><strong>Ve√≠culos:</strong> ${customer.vehicles ? customer.vehicles.length : 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Fun√ß√µes auxiliares
        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('customersContainer').innerHTML = '';
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').innerHTML = `<div style="text-align: center; padding: 1rem; color: var(--error-color); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">‚ùå ${message}</div>`;
        }

        // Carregar clientes ao inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomers();
        });
    </script>
</body>
</html>

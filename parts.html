<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pe√ßas - Oficina Mec√¢nica</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-layout">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span class="logo-icon">üöó</span>
                <span>Minha Oficina</span>
            </a>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/dashboard.html" class="nav-link">
                            <span>üìä</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/customers.html" class="nav-link">
                            <span>üë•</span>
                            Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/service-orders.html" class="nav-link">
                            <span>üîß</span>
                            Ordens de Servi√ßo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/parts.html" class="nav-link active">
                            <span>‚öôÔ∏è</span>
                            Pe√ßas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/financial.html" class="nav-link">
                            <span>üí∞</span>
                            Financeiro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/reports.html" class="nav-link">
                            <span>üìà</span>
                            Relat√≥rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/settings.html" class="nav-link">
                            <span>‚öôÔ∏è</span>
                            Configura√ß√µes
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="user-menu">
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar">U</div>
                    <span id="userName">Usu√°rio</span>
                    <span>‚ñº</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="card">
            <div class="card-header">
                <div>
                    <h1 class="card-title">
                        <span>‚öôÔ∏è</span>
                        Gest√£o de Pe√ßas
                    </h1>
                    <p class="card-subtitle">Controle de estoque e pe√ßas da oficina</p>
                </div>
                <a href="/part-form.html" class="btn btn-primary">
                    <span>‚ûï</span>
                    Nova Pe√ßa
                </a>
            </div>
        </div>

        <!-- Estat√≠sticas R√°pidas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="totalParts">-</div>
                        <div class="stat-label">Total de Pe√ßas</div>
                    </div>
                    <div class="stat-icon primary">‚öôÔ∏è</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="lowStockParts">-</div>
                        <div class="stat-label">Estoque Baixo</div>
                    </div>
                    <div class="stat-icon warning">‚ö†Ô∏è</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="outOfStockParts">-</div>
                        <div class="stat-label">Sem Estoque</div>
                    </div>
                    <div class="stat-icon error">‚ùå</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="totalValue">R$ -</div>
                        <div class="stat-label">Valor Total</div>
                    </div>
                    <div class="stat-icon success">üí∞</div>
                </div>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üîç</span>
                    Buscar Pe√ßas
                </h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchName" class="form-label">Nome da Pe√ßa</label>
                        <input type="text" id="searchName" class="form-input" placeholder="Digite o nome da pe√ßa">
                    </div>
                    <div class="form-group">
                        <label for="searchCode" class="form-label">C√≥digo</label>
                        <input type="text" id="searchCode" class="form-input" placeholder="C√≥digo interno ou barcode">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchCategory" class="form-label">Categoria</label>
                        <select id="searchCategory" class="form-input">
                            <option value="">Todas</option>
                            <option value="PARTS">Pe√ßas</option>
                            <option value="SUPPLIES">Insumos</option>
                            <option value="ACCESSORIES">Acess√≥rios</option>
                            <option value="TOOLS">Ferramentas</option>
                            <option value="CONSUMABLES">Consum√≠veis</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchStatus" class="form-label">Status</label>
                        <select id="searchStatus" class="form-input">
                            <option value="">Todos</option>
                            <option value="ACTIVE">Ativo</option>
                            <option value="INACTIVE">Inativo</option>
                            <option value="DISCONTINUED">Descontinuado</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <button onclick="searchParts()" class="btn btn-primary">
                        <span>üîç</span>
                        Buscar
                    </button>
                    <button onclick="clearSearch()" class="btn btn-secondary">
                        <span>üóëÔ∏è</span>
                        Limpar
                    </button>
                    <button onclick="loadParts()" class="btn btn-success">
                        <span>üìã</span>
                        Listar Todas
                    </button>
                    <button onclick="showLowStock()" class="btn btn-warning">
                        <span>‚ö†Ô∏è</span>
                        Estoque Baixo
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Pe√ßas -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üìã</span>
                    Lista de Pe√ßas
                </h2>
                <div class="card-subtitle">
                    Total: <span id="totalPartsDisplay">0</span> pe√ßas
                </div>
            </div>
            <div class="card-body">
                <div id="loadingMessage" style="display: none;">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">Carregando pe√ßas...</p>
                    </div>
                </div>
                
                <div id="errorMessage" style="display: none;"></div>
                
                <div id="partsContainer">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <p>Clique em "Listar Todas" para carregar as pe√ßas</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/logo-manager.js"></script>
    <script src="/modelo2-features.js"></script>
    
    <script>
        // Verificar autentica√ß√£o
        const auth = new AuthManager();
        if (!auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        // Atualizar nome do usu√°rio
        const user = auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name || user.email;
            document.querySelector('.user-avatar').textContent = (user.name || user.email).charAt(0).toUpperCase();
        }

        // Toggle user menu
        function toggleUserMenu() {
            const confirmed = confirm('Deseja fazer logout?');
            if (confirmed) {
                auth.logout();
                window.location.href = '/login.html';
            }
        }

        // Fun√ß√µes da API
        async function apiCall(endpoint) {
            try {
                const response = await fetch(endpoint);
                return await response.json();
            } catch (error) {
                throw new Error(`Erro na API: ${error.message}`);
            }
        }

        // Carregar pe√ßas
        async function loadParts() {
            showLoading();
            try {
                const response = await apiCall('/api/parts');
                const parts = response.data || response;
                displayParts(parts);
                updateStats(parts);
                document.getElementById('totalPartsDisplay').textContent = parts.length;
            } catch (error) {
                showError('Erro ao carregar pe√ßas: ' + error.message);
            }
        }

        // Buscar pe√ßas
        async function searchParts() {
            const name = document.getElementById('searchName').value;
            const code = document.getElementById('searchCode').value;
            const category = document.getElementById('searchCategory').value;
            const status = document.getElementById('searchStatus').value;

            if (!name && !code && !category && !status) {
                alert('Digite pelo menos um crit√©rio de busca');
                return;
            }

            showLoading();
            try {
                const response = await apiCall('/api/parts');
                const parts = response.data || response;
                
                const filtered = parts.filter(part => {
                    return (!name || part.name.toLowerCase().includes(name.toLowerCase())) &&
                           (!code || part.internalCode?.includes(code) || part.barcode?.includes(code)) &&
                           (!category || part.category === category) &&
                           (!status || part.status === status);
                });

                displayParts(filtered);
                updateStats(filtered);
                document.getElementById('totalPartsDisplay').textContent = filtered.length;
            } catch (error) {
                showError('Erro ao buscar pe√ßas: ' + error.message);
            }
        }

        // Mostrar pe√ßas com estoque baixo
        async function showLowStock() {
            showLoading();
            try {
                const response = await apiCall('/api/parts');
                const parts = response.data || response;
                
                const lowStock = parts.filter(part => part.stock <= part.minStock);
                displayParts(lowStock);
                updateStats(lowStock);
                document.getElementById('totalPartsDisplay').textContent = lowStock.length;
            } catch (error) {
                showError('Erro ao carregar pe√ßas com estoque baixo: ' + error.message);
            }
        }

        // Limpar busca
        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchCode').value = '';
            document.getElementById('searchCategory').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('partsContainer').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);"><p>Clique em "Listar Todas" para carregar as pe√ßas</p></div>';
            document.getElementById('totalPartsDisplay').textContent = '0';
        }

        // Atualizar estat√≠sticas
        function updateStats(parts) {
            const total = parts.length;
            const lowStock = parts.filter(p => p.stock <= p.minStock).length;
            const outOfStock = parts.filter(p => p.stock === 0).length;
            const totalValue = parts.reduce((sum, p) => sum + (p.salePrice * p.stock), 0);

            document.getElementById('totalParts').textContent = total;
            document.getElementById('lowStockParts').textContent = lowStock;
            document.getElementById('outOfStockParts').textContent = outOfStock;
            document.getElementById('totalValue').textContent = `R$ ${totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        // Exibir pe√ßas
        function displayParts(parts) {
            const container = document.getElementById('partsContainer');
            
            if (parts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);"><p>Nenhuma pe√ßa encontrada</p></div>';
                return;
            }

            let html = '<div class="stats-grid">';
            
            parts.forEach(part => {
                const stockStatus = part.stock === 0 ? 'error' : part.stock <= part.minStock ? 'warning' : 'success';
                const stockText = part.stock === 0 ? 'Sem estoque' : part.stock <= part.minStock ? 'Estoque baixo' : 'Em estoque';
                
                html += `
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-3);">
                                <div>
                                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-1);">${part.name}</h3>
                                    <div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <span class="badge badge-primary">${part.category}</span>
                                        <span class="badge badge-${stockStatus}">${stockText}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: var(--space-2);">
                                    <a href="/part-view.html?id=${part.id}" class="btn btn-sm btn-secondary">üëÅÔ∏è Ver</a>
                                    <a href="/part-form.html?id=${part.id}" class="btn btn-sm btn-primary">‚úèÔ∏è Editar</a>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2); font-size: var(--font-size-sm); color: var(--text-secondary);">
                                <div><strong>C√≥digo:</strong> ${part.internalCode || 'N/A'}</div>
                                <div><strong>Marca:</strong> ${part.brand || 'N/A'}</div>
                                <div><strong>Estoque:</strong> ${part.stock} ${part.unit}</div>
                                <div><strong>Pre√ßo:</strong> R$ ${part.salePrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Fun√ß√µes auxiliares
        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('partsContainer').innerHTML = '';
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').innerHTML = `<div style="text-align: center; padding: 1rem; color: var(--error-color); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">‚ùå ${message}</div>`;
        }

        // Carregar pe√ßas ao inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadParts();
        });
    </script>
</body>
</html>
